<html lang="pt">
<head>
    <title>Contacts - <%= (contact && contact.id) ? 'Edit - ' + contact.email : 'New' %></title>
    <%- include('../common/head.ejs') %>
</head>
<body class="bg-light">

<%- include('common/nav.ejs', {title: 'Contacts - ' + (contact && contact.id ? ('Edit - ' + contact.email) : 'New'), user}) %>

<div class="container" style="margin-top: 80px;">
    <% if (!contact) { %>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Contato não encontrado!</h4>
            <a href="<%= previous ? previous : '/contacts'%>" class="btn btn-primary">Voltar</a>
        </div>
    <% } else { %>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2></h2>
            <a href="<%= previous ? previous : '/contacts'%>" class="btn btn-primary">Voltar</a>
        </div>

        <form id="contactForm" enctype="multipart/form-data" novalidate class="needs-validation">
            <div class="mb-3">
                <label for="name" class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="name" name="name" value="<%= contact.name %>" required>
                <div class="invalid-feedback">Nome é obrigatório.</div>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">E-mail</label>
                <input type="email" class="form-control" id="email" name="email" value="<%= contact.email %>" required>
                <div class="invalid-feedback">E-mail válido é obrigatório.</div>
            </div>

            <div class="mb-3">
                <label for="phone" class="form-label">Celular</label>
                <input type="text" class="form-control" id="phone" name="phone" value="<%= contact.phone %>" required>
                <div class="invalid-feedback">Número de celular é obrigatório.</div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">Endereço</label>
                <input type="text" class="form-control" id="address" name="address" value="<%= contact.address %>"
                       required>
                <div class="invalid-feedback">Endereço é obrigatório.</div>
            </div>

            <div class="mb-3">
                <label for="photo" class="form-label">Foto de Perfil</label>
                <input type="file" class="form-control" id="photo" name="photo"
                       accept="image/*" <%= contact.address ? '' : 'required' %>>
                <div class="invalid-feedback">A foto é obrigatória.</div>
            </div>

            <button type="submit" class="btn btn-primary">Salvar Contato</button>
        </form>
    <% } %>
</div>
<script>
    (() => {
        'use strict';

        let url = "<%= contact.id
                ? ('/api/contacts/' + contact.id + '/update')
                : '/api/contacts/create' %>"

        let axiosMethod = "<%= contact.id
                ? 'put'
                : 'post' %>";

        const form = document.querySelector('#contactForm');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            event.stopPropagation();

            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const formData = new FormData(form);

            try {
                await axios.request({
                    data: formData,
                    method: axiosMethod,
                    url
                });
                window.location.href = '/contacts';
            } catch (error) {
                let type = error.response && error.response.data && error.response.data.type ? error.response.data.type : 'error';
                if (type === 'phone') {
                    toastr.error('Telefone já está em uso em outro contato.');
                    return;
                }
                if (type === 'email') {
                    toastr.error('Email já está em uso em outro contato.');
                    return;
                }
                toastr.error('Erro ao salvar contato. Verifique os dados e tente novamente.');
            }
        });
    })();
</script>
<%- include('../common/end') %>
</body>
</html>